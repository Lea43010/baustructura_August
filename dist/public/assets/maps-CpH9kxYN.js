import{c as re,a2 as ie,r as f,a3 as oe,j as e,I as Z,L as ce,u as de,e as ue,w as se,x as me,B as D,D as V}from"./index-CyhjQ_VK.js";import{S as he,a as ge,b as fe,c as pe,d as ne}from"./select-D1rr0yyK.js";import{S as xe}from"./search-_i4Cbbz2.js";import{M as Y}from"./map-pin-LITRY39W.js";import{A as we}from"./arrow-left-C8JrTeqc.js";import{T as le}from"./trash-2-Bnck2P-r.js";import{E as B}from"./external-link-Cj6IOzed.js";import"./index-BdQq_4o_.js";import"./Combination-DDccCRPx.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=re("Layers",[["path",{d:"m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z",key:"8b97xw"}],["path",{d:"m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65",key:"dd6zsq"}],["path",{d:"m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65",key:"ep9fru"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=re("Ruler",[["path",{d:"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",key:"icamh8"}],["path",{d:"m14.5 12.5 2-2",key:"inckbg"}],["path",{d:"m11.5 9.5 2-2",key:"fmmyf7"}],["path",{d:"m8.5 6.5 2-2",key:"vc6u1g"}],["path",{d:"m17.5 15.5 2-2",key:"wo5hmg"}]]);var Q={exports:{}};function ve(p,a,r,d){function g(m){return m instanceof r?m:new r(function(i){i(m)})}return new(r||(r=Promise))(function(m,i){function y(v){try{b(d.next(v))}catch(u){i(u)}}function h(v){try{b(d.throw(v))}catch(u){i(u)}}function b(v){v.done?m(v.value):g(v.value).then(y,h)}b((d=d.apply(p,[])).next())})}function je(p){return p&&p.__esModule&&Object.prototype.hasOwnProperty.call(p,"default")?p.default:p}var J,ae;function Ne(){return ae||(ae=1,J=function p(a,r){if(a===r)return!0;if(a&&r&&typeof a=="object"&&typeof r=="object"){if(a.constructor!==r.constructor)return!1;var d,g,m;if(Array.isArray(a)){if(d=a.length,d!=r.length)return!1;for(g=d;g--!==0;)if(!p(a[g],r[g]))return!1;return!0}if(a.constructor===RegExp)return a.source===r.source&&a.flags===r.flags;if(a.valueOf!==Object.prototype.valueOf)return a.valueOf()===r.valueOf();if(a.toString!==Object.prototype.toString)return a.toString()===r.toString();if(m=Object.keys(a),d=m.length,d!==Object.keys(r).length)return!1;for(g=d;g--!==0;)if(!Object.prototype.hasOwnProperty.call(r,m[g]))return!1;for(g=d;g--!==0;){var i=m[g];if(!p(a[i],r[i]))return!1}return!0}return a!==a&&r!==r}),J}var Me=Ne(),Se=je(Me);const ee="__googleMapsScriptId";var K;(function(p){p[p.INITIALIZED=0]="INITIALIZED",p[p.LOADING=1]="LOADING",p[p.SUCCESS=2]="SUCCESS",p[p.FAILURE=3]="FAILURE"})(K||(K={}));class T{constructor({apiKey:a,authReferrerPolicy:r,channel:d,client:g,id:m=ee,language:i,libraries:y=[],mapIds:h,nonce:b,region:v,retries:u=3,url:S="https://maps.googleapis.com/maps/api/js",version:P}){if(this.callbacks=[],this.done=!1,this.loading=!1,this.errors=[],this.apiKey=a,this.authReferrerPolicy=r,this.channel=d,this.client=g,this.id=m||ee,this.language=i,this.libraries=y,this.mapIds=h,this.nonce=b,this.region=v,this.retries=u,this.url=S,this.version=P,T.instance){if(!Se(this.options,T.instance.options))throw new Error(`Loader must not be called again with different options. ${JSON.stringify(this.options)} !== ${JSON.stringify(T.instance.options)}`);return T.instance}T.instance=this}get options(){return{version:this.version,apiKey:this.apiKey,channel:this.channel,client:this.client,id:this.id,libraries:this.libraries,language:this.language,region:this.region,mapIds:this.mapIds,nonce:this.nonce,url:this.url,authReferrerPolicy:this.authReferrerPolicy}}get status(){return this.errors.length?K.FAILURE:this.done?K.SUCCESS:this.loading?K.LOADING:K.INITIALIZED}get failed(){return this.done&&!this.loading&&this.errors.length>=this.retries+1}createUrl(){let a=this.url;return a+="?callback=__googleMapsCallback&loading=async",this.apiKey&&(a+=`&key=${this.apiKey}`),this.channel&&(a+=`&channel=${this.channel}`),this.client&&(a+=`&client=${this.client}`),this.libraries.length>0&&(a+=`&libraries=${this.libraries.join(",")}`),this.language&&(a+=`&language=${this.language}`),this.region&&(a+=`&region=${this.region}`),this.version&&(a+=`&v=${this.version}`),this.mapIds&&(a+=`&map_ids=${this.mapIds.join(",")}`),this.authReferrerPolicy&&(a+=`&auth_referrer_policy=${this.authReferrerPolicy}`),a}deleteScript(){const a=document.getElementById(this.id);a&&a.remove()}load(){return this.loadPromise()}loadPromise(){return new Promise((a,r)=>{this.loadCallback(d=>{d?r(d.error):a(window.google)})})}importLibrary(a){return this.execute(),google.maps.importLibrary(a)}loadCallback(a){this.callbacks.push(a),this.execute()}setScript(){var a,r;if(document.getElementById(this.id)){this.callback();return}const d={key:this.apiKey,channel:this.channel,client:this.client,libraries:this.libraries.length&&this.libraries,v:this.version,mapIds:this.mapIds,language:this.language,region:this.region,authReferrerPolicy:this.authReferrerPolicy};Object.keys(d).forEach(m=>!d[m]&&delete d[m]),!((r=(a=window==null?void 0:window.google)===null||a===void 0?void 0:a.maps)===null||r===void 0)&&r.importLibrary||(m=>{let i,y,h,b="The Google Maps JavaScript API",v="google",u="importLibrary",S="__ib__",P=document,k=window;k=k[v]||(k[v]={});const N=k.maps||(k.maps={}),o=new Set,j=new URLSearchParams,E=()=>i||(i=new Promise((I,C)=>ve(this,void 0,void 0,function*(){var $;yield y=P.createElement("script"),y.id=this.id,j.set("libraries",[...o]+"");for(h in m)j.set(h.replace(/[A-Z]/g,A=>"_"+A[0].toLowerCase()),m[h]);j.set("callback",v+".maps."+S),y.src=this.url+"?"+j,N[S]=I,y.onerror=()=>i=C(Error(b+" could not load.")),y.nonce=this.nonce||(($=P.querySelector("script[nonce]"))===null||$===void 0?void 0:$.nonce)||"",P.head.append(y)})));N[u]?console.warn(b+" only loads once. Ignoring:",m):N[u]=(I,...C)=>o.add(I)&&E().then(()=>N[u](I,...C))})(d);const g=this.libraries.map(m=>this.importLibrary(m));g.length||g.push(this.importLibrary("core")),Promise.all(g).then(()=>this.callback(),m=>{const i=new ErrorEvent("error",{error:m});this.loadErrorCallback(i)})}reset(){this.deleteScript(),this.done=!1,this.loading=!1,this.errors=[],this.onerrorEvent=null}resetIfRetryingFailed(){this.failed&&this.reset()}loadErrorCallback(a){if(this.errors.push(a),this.errors.length<=this.retries){const r=this.errors.length*Math.pow(2,this.errors.length);console.error(`Failed to load Google Maps script, retrying in ${r} ms.`),setTimeout(()=>{this.deleteScript(),this.setScript()},r)}else this.onerrorEvent=a,this.callback()}callback(){this.done=!0,this.loading=!1,this.callbacks.forEach(a=>{a(this.onerrorEvent)}),this.callbacks=[]}execute(){if(this.resetIfRetryingFailed(),!this.loading)if(this.done)this.callback();else{if(window.google&&window.google.maps&&window.google.maps.version){console.warn("Google Maps already loaded outside @googlemaps/js-api-loader. This may result in undesirable behavior as options and script parameters may not match."),this.callback();return}this.loading=!0,this.setScript()}}}const ke=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_ID:ee,Loader:T,get LoaderStatus(){return K}},Symbol.toStringTag,{value:"Module"})),Ee=ie(ke);(function(p,a){(function(r,d){d(a,Ee,f)})(oe,function(r,d,g){function m(h){return h&&typeof h=="object"&&"default"in h?h:{default:h}}var i=m(g);r.Status=void 0,function(h){h.LOADING="LOADING",h.FAILURE="FAILURE",h.SUCCESS="SUCCESS"}(r.Status||(r.Status={}));const y=({children:h,render:b,callback:v,...u})=>{const[S,P]=g.useState(r.Status.LOADING);return g.useEffect(()=>{const k=new d.Loader(u),N=o=>{v&&v(o,k),P(o)};N(r.Status.LOADING),k.load().then(()=>N(r.Status.SUCCESS),()=>N(r.Status.FAILURE))},[]),S===r.Status.SUCCESS&&h?i.default.createElement(i.default.Fragment,null,h):b?b(S):i.default.createElement(i.default.Fragment,null)};r.Wrapper=y,Object.defineProperty(r,"__esModule",{value:!0})})})(Q,Q.exports);var X=Q.exports;const Ie=({onLocationSelect:p,placeholder:a="Adresse, PLZ oder Hausnummer suchen (z.B. 80331 München, Maximilianstraße 15)..."})=>{const[r,d]=f.useState(""),[g,m]=f.useState([]),[i,y]=f.useState(!1),[h,b]=f.useState(!1),v=async o=>{if(!(o.length<3)){y(!0);try{const j=/\d/.test(o),E=/^\d{5}/.test(o.trim()),I=/\d+[a-zA-Z]?\s*$/.test(o);console.log("🔍 Search analysis:",{hasNumbers:j,hasPostcode:E,hasHouseNumber:I,query:o});let C=[];E?C.push(fetch(`https://nominatim.openstreetmap.org/search?format=json&postalcode=${encodeURIComponent(o.trim())}&countrycodes=de&limit=10&addressdetails=1&dedupe=1`).then(w=>w.json()).then(w=>({source:"PLZ-Suche",data:w}))):I?C.push(fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&countrycodes=de&limit=15&addressdetails=1&dedupe=1&layer=address`).then(w=>w.json()).then(w=>({source:"Adress-Suche",data:w}))):C.push(fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&countrycodes=de&limit=12&addressdetails=1&dedupe=1&layer=address,locality&bounded=1&viewbox=5.866,47.270,15.042,55.058`).then(w=>w.json()).then(w=>({source:"Standard-Suche",data:w}))),E||C.push(fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&countrycodes=de&limit=8&addressdetails=1&dedupe=1&bounded=1&viewbox=5.866,47.270,15.042,55.058`).then(w=>w.json()).then(w=>({source:"Deutschland-Suche",data:w})));const $=await Promise.allSettled(C);let A=[];$.forEach((w,z)=>{if(w.status==="fulfilled"&&w.value){const{source:U,data:L}=w.value;if(U==="Photon"&&L.features){const O=L.features.filter(M=>{var s;const l=M.properties;return l.country==="Deutschland"||l.country==="Germany"||l.countrycode==="DE"||((s=l.state)==null?void 0:s.includes("Deutschland"))}).map((M,l)=>{const s=M.properties,n=M.geometry.coordinates;let t=s.name||s.street||o,c="";s.housenumber&&(t=`${s.street||s.name} ${s.housenumber}`);const x=[];return s.postcode&&x.push(s.postcode),s.city&&x.push(s.city),s.state&&s.state!==s.city&&x.push(s.state),x.length===0&&x.push("Deutschland"),c=x.join(", "),{place_id:`photon_${l}`,description:`${t}, ${c}`,structured_formatting:{main_text:t,secondary_text:c},geometry:{location:{lat:n[1],lng:n[0]}},source:U,priority:s.housenumber?3:s.postcode?2:1}});A=[...A,...O]}else if(Array.isArray(L)){const O=L.map((M,l)=>{const s=M.address||{};let n=M.name||M.display_name.split(",")[0];s.house_number&&s.road?n=`${s.road} ${s.house_number}`:s.road&&(n=s.road);const t=[];s.postcode&&t.push(s.postcode),(s.city||s.town||s.village)&&t.push(s.city||s.town||s.village),s.state&&s.state!==(s.city||s.town)&&t.push(s.state);const c=t.length>0?t.join(", "):M.display_name.split(",").slice(1).join(",").trim();return{place_id:`nominatim_${l}`,description:`${n}, ${c}`,structured_formatting:{main_text:n,secondary_text:c},geometry:{location:{lat:parseFloat(M.lat),lng:parseFloat(M.lon)}},source:U,priority:s.house_number?3:s.postcode?2:1}});A=[...A,...O]}}});const R=A.filter((w,z,U)=>z===U.findIndex(L=>Math.abs(L.geometry.location.lat-w.geometry.location.lat)<1e-4&&Math.abs(L.geometry.location.lng-w.geometry.location.lng)<1e-4)).sort((w,z)=>(z.priority||0)-(w.priority||0)).slice(0,12);console.log("🎯 Optimized search results:",R.length,"found for:",o),m(R),b(R.length>0)}catch(j){console.error("🚨 Address search error:",j),m([]),b(!1)}finally{y(!1)}}},[u,S]=f.useState(null),P=o=>{if(d(o),console.log("Direct search input:",o),u&&clearTimeout(u),o.length>=3){const j=setTimeout(()=>{v(o)},400);S(j)}else m([]),b(!1)},k=o=>{console.log("🎯 Selected prediction:",o),d(o.description),b(!1),console.log("📍 Selected location data:",{address:o.description,lat:o.geometry.location.lat,lng:o.geometry.location.lng}),p({address:o.description,lat:o.geometry.location.lat,lng:o.geometry.location.lng})},N=o=>{o.key==="Enter"&&g.length>0&&(o.preventDefault(),k(g[0]))};return e.jsx("div",{className:"relative",children:e.jsx("div",{className:"flex space-x-2",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(xe,{className:"absolute left-3 top-3 h-4 w-4 text-gray-400"}),e.jsx(Z,{type:"text",placeholder:a,value:r,onChange:o=>P(o.target.value),onKeyPress:N,onFocus:()=>{g.length>0&&b(!0)},onBlur:()=>{setTimeout(()=>b(!1),200)},className:"pl-10",disabled:i}),i&&e.jsx(ce,{className:"absolute right-3 top-3 h-4 w-4 animate-spin text-gray-400"}),h&&g.length>0&&e.jsx("div",{className:"absolute z-[9999] w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto",children:g.map(o=>e.jsx("div",{className:"px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0",onClick:()=>k(o),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Y,{className:"h-4 w-4 text-gray-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:o.structured_formatting.main_text}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:o.structured_formatting.secondary_text}),o.source&&e.jsx("p",{className:"text-xs text-blue-500 mt-1",children:o.source})]})]})},o.place_id))}),h&&g.length===0&&r.length>=3&&!i&&e.jsx("div",{className:"absolute z-[9999] w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg",children:e.jsx("div",{className:"px-4 py-3 text-sm text-gray-500 text-center",children:"Keine Vorschläge gefunden"})})]})})})};let W="";function Ce({projects:p,selectedProject:a,onProjectSelect:r,markers:d,onMarkerAdd:g,onMarkersCleared:m,searchLocation:i,drawingMode:y,onDrawingModeChange:h,onMapReady:b}){const v=f.useRef(null),[u,S]=f.useState(null),[P,k]=f.useState([]),[N,o]=f.useState([]),[j,E]=f.useState(null),[I,C]=f.useState([]),[$,A]=f.useState(null),[R,w]=f.useState(null),[z,U]=f.useState(!1);f.useEffect(()=>{if(console.log("🔍 Search location effect triggered:",i),u&&i&&typeof i.lat=="number"&&typeof i.lng=="number"&&!isNaN(i.lat)&&!isNaN(i.lng)){console.log("📍 Creating search marker and jumping to location"),j&&(j.setMap(null),console.log("🗑️ Previous search marker removed"));const n=new window.google.maps.Marker({position:{lat:Number(i.lat),lng:Number(i.lng)},map:u,title:`Suchergebnis: ${i.address}`,icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
            <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
              <circle cx="20" cy="20" r="16" fill="#dc2626" stroke="#ffffff" stroke-width="4"/>
              <circle cx="20" cy="20" r="8" fill="#ffffff"/>
              <text x="20" y="26" text-anchor="middle" fill="#dc2626" font-size="12" font-weight="bold">📍</text>
            </svg>
          `),scaledSize:new window.google.maps.Size(40,40),anchor:new window.google.maps.Point(20,20)},animation:window.google.maps.Animation.DROP,zIndex:1e3}),t=new window.google.maps.InfoWindow({content:`
          <div style="padding: 10px; max-width: 250px;">
            <h4 style="margin: 0 0 8px 0; font-weight: bold; color: #dc2626;">🔍 Suchergebnis</h4>
            <p style="margin: 0 0 4px 0; font-size: 14px;">${i.address}</p>
            <small style="color: #666;">Koordinaten: ${i.lat.toFixed(6)}, ${i.lng.toFixed(6)}</small>
          </div>
        `});n.addListener("click",()=>{t.open(u,n)}),u.panTo({lat:Number(i.lat),lng:Number(i.lng)}),u.setZoom(17),E(n),setTimeout(()=>{n&&n.getMap()&&(n.setAnimation(null),console.log("🔻 Search marker animation stopped"))},2e3),console.log("✅ Search marker created and map jumped to location")}},[u,i]),f.useEffect(()=>(window.clearSearchMarker=()=>{j&&(j.setMap(null),E(null),console.log("🧹 Search marker cleared via global function"))},window.clearAllMapMarkers=()=>{console.log("🧹 Clearing all map markers via global function"),N.forEach(n=>{n&&n.setMap&&n.setMap(null)}),o([]),j&&(j.setMap(null),E(null)),I.forEach(n=>{n&&n.setMap&&n.setMap(null)}),C([]),$&&($.setMap(null),A(null)),console.log("✅ All map markers cleared")},()=>{delete window.clearSearchMarker,delete window.clearAllMapMarkers}),[j,N,I,$]),f.useEffect(()=>()=>{j&&(j.setMap(null),console.log("🧹 Search marker cleaned up on unmount"))},[j]),f.useEffect(()=>{if(u&&z){const n=u.addListener("click",t=>{const c={lat:t.latLng.lat(),lng:t.latLng.lng()};console.log("📏 Measurement click:",c),L(c)});return()=>{n&&window.google.maps.event.removeListener(n)}}},[u,z]);const L=n=>{I.length>=2&&s();const t=I.length+1,c=new window.google.maps.Marker({position:n,map:u,title:`Messpunkt ${t}`,icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
          <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
            <circle cx="16" cy="16" r="12" fill="#2563eb" stroke="#ffffff" stroke-width="3"/>
            <circle cx="16" cy="16" r="6" fill="#ffffff"/>
            <text x="16" y="21" text-anchor="middle" fill="#2563eb" font-size="10" font-weight="bold">${t}</text>
          </svg>
        `),scaledSize:new window.google.maps.Size(32,32),anchor:new window.google.maps.Point(16,16)},animation:window.google.maps.Animation.DROP,zIndex:900}),x=[...I,c];C(x);const _=new window.google.maps.InfoWindow({content:`
        <div style="padding: 8px; max-width: 200px;">
          <h4 style="margin: 0 0 4px 0; color: #2563eb;">📏 Messpunkt ${t}</h4>
          <small style="color: #666;">Lat: ${n.lat.toFixed(6)}<br>Lng: ${n.lng.toFixed(6)}</small>
        </div>
      `});c.addListener("click",()=>{_.open(u,c)}),x.length===2&&O(x)},O=n=>{if(n.length!==2)return;const t=n[0].getPosition(),c=n[1].getPosition(),x=M(t.lat(),t.lng(),c.lat(),c.lng());w(x);const _=new window.google.maps.Polyline({path:[t,c],geodesic:!0,strokeColor:"#2563eb",strokeOpacity:1,strokeWeight:3,map:u});A(_);const F={lat:(t.lat()+c.lat())/2,lng:(t.lng()+c.lng())/2};new window.google.maps.InfoWindow({position:F,content:`
        <div style="padding: 10px; text-align: center;">
          <h4 style="margin: 0 0 4px 0; color: #2563eb;">📏 Distanz</h4>
          <strong style="font-size: 16px; color: #1f2937;">${l(x)}</strong>
          <br><small style="color: #666;">Luftlinie</small>
        </div>
      `,map:u}),console.log(`📏 Distance calculated: ${x}m (${l(x)})`)},M=(n,t,c,x)=>{const F=n*Math.PI/180,q=c*Math.PI/180,G=(c-n)*Math.PI/180,H=(x-t)*Math.PI/180,te=Math.sin(G/2)*Math.sin(G/2)+Math.cos(F)*Math.cos(q)*Math.sin(H/2)*Math.sin(H/2);return 6371e3*(2*Math.atan2(Math.sqrt(te),Math.sqrt(1-te)))},l=n=>n<1e3?`${n.toFixed(1)}m`:`${(n/1e3).toFixed(2)}km`,s=()=>{I.forEach(n=>{n.setMap(null)}),C([]),$&&($.setMap(null),A(null)),w(null),console.log("🧹 Measurement cleared")};return f.useEffect(()=>{W=y,console.log("🎨 Drawing mode updated to:",W)},[y]),f.useEffect(()=>{var n;if(v.current&&!u&&((n=window.google)!=null&&n.maps)){console.log("🗺️ Initializing map...");const t=new window.google.maps.Map(v.current,{center:{lat:48.1351,lng:11.582},zoom:12,mapTypeControl:!0,streetViewControl:!0,fullscreenControl:!0,zoomControl:!0,gestureHandling:"greedy"});t.addListener("click",c=>{const x={lat:c.latLng.lat(),lng:c.latLng.lng()};console.log("🗺️ Map clicked! Drawing mode:",W),W==="marker"?(console.log("✅ Creating marker at:",x),g({lat:Number(x.lat),lng:Number(x.lng),title:`Marker ${new Date().toLocaleTimeString("de-DE")}`,description:`Position: ${x.lat.toFixed(6)}, ${x.lng.toFixed(6)}`,type:"marker",projectId:a==null?void 0:a.id,color:"#dc2626",icon:"📍"}),h(""),console.log("🔄 Drawing mode reset")):console.log("❌ Not in marker mode, ignoring click")}),S(t),b&&b(t),console.log("✅ Map initialized successfully")}},[]),f.useEffect(()=>{if(u&&p){P.forEach(t=>t.setMap(null));const n=p.filter(t=>t.latitude&&t.longitude&&typeof t.latitude=="number"&&typeof t.longitude=="number"&&!isNaN(t.latitude)&&!isNaN(t.longitude)).map(t=>{console.log("📍 Creating project marker for:",t.name);const c=new window.google.maps.Marker({position:{lat:Number(t.latitude),lng:Number(t.longitude)},map:u,title:t.name,icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
                <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="16" cy="16" r="12" fill="#10b981" stroke="#ffffff" stroke-width="2"/>
                  <text x="16" y="20" text-anchor="middle" fill="white" font-size="12" font-weight="bold">P</text>
                </svg>
              `),scaledSize:new window.google.maps.Size(32,32)}}),x=new window.google.maps.InfoWindow({content:""});return c.addListener("click",()=>{let _="";if(i){const F=M(Number(t.latitude),Number(t.longitude),Number(i.lat),Number(i.lng));_=`
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                  <small style="color: #2563eb; font-weight: bold;">📏 Entfernung zum Suchmarker: ${l(F)}</small>
                </div>
              `}x.setContent(`
              <div style="padding: 10px; max-width: 250px;">
                <h4 style="margin: 0 0 8px 0; font-weight: bold; color: #10b981;">🏗️ ${t.name}</h4>
                <p style="margin: 0 0 4px 0; font-size: 14px;">${t.description||"Kein Beschreibung verfügbar"}</p>
                <div style="margin: 4px 0; font-size: 12px; color: #666;">
                  <div>📍 ${t.latitude||0}, ${t.longitude||0}</div>
                  <div>📅 Status: ${t.status}</div>
                </div>
                ${_}
              </div>
            `),x.open(u,c),r(t)}),c});k(n)}},[u,p,r]),f.useEffect(()=>{if(console.log("🎨 Rendering custom markers. Count:",d.length),N.forEach(n=>{n&&n.setMap&&n.setMap(null)}),o([]),u&&d&&d.length>0){const n=[];d.forEach((t,c)=>{if(console.log(`📍 Creating custom marker ${c+1}:`,t),typeof t.lat=="number"&&typeof t.lng=="number"&&!isNaN(t.lat)&&!isNaN(t.lng)){const x=new window.google.maps.Marker({position:{lat:Number(t.lat),lng:Number(t.lng)},map:u,title:t.title,icon:{url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`
                <svg width="32" height="32" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="16" cy="16" r="12" fill="${t.color}" stroke="#ffffff" stroke-width="2"/>
                  <circle cx="16" cy="16" r="4" fill="#ffffff"/>
                  <text x="16" y="20" text-anchor="middle" fill="#000000" font-size="10" font-weight="bold">M</text>
                </svg>
              `),scaledSize:new window.google.maps.Size(32,32)},animation:window.google.maps.Animation.DROP});console.log(`✅ Custom marker created at ${t.lat}, ${t.lng}`);let _="";if(i){const q=M(t.lat,t.lng,i.lat,i.lng);_=`
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                <small style="color: #2563eb; font-weight: bold;">📏 Entfernung zum Suchmarker: ${l(q)}</small>
              </div>
            `}const F=new window.google.maps.InfoWindow({content:`
              <div style="padding: 8px;">
                <h4 style="margin: 0 0 4px 0; font-weight: bold;">${t.title}</h4>
                <p style="margin: 0 0 4px 0;">${t.description}</p>
                <small style="color: #666;">Erstellt: ${new Date(t.createdAt).toLocaleString("de-DE")}</small>
                ${_}
              </div>
            `});x.addListener("click",()=>{F.open(u,x)}),n.push(x)}}),o(n)}},[u,d]),f.useEffect(()=>{window.clearMapMarkers=()=>{console.log("🗑️ Clearing all custom markers from map"),N.forEach(n=>{n.setMap(null)}),o([]),m&&m()}},[N,m]),e.jsx("div",{ref:v,className:"w-full h-full"})}function Oe(){const{toast:p}=de(),[a]=ue(),[r,d]=f.useState([]),[g,m]=f.useState(null),[i,y]=f.useState(null),[h,b]=f.useState(""),[v,u]=f.useState(null),[S,P]=f.useState([]),[k,N]=f.useState(null),[o,j]=f.useState(null),[E,I]=f.useState(!1);f.useEffect(()=>{r.length>0&&d([])},[]),f.useEffect(()=>{const l=new URLSearchParams(window.location.search),s=l.get("address"),n=l.get("lat"),t=l.get("lng");if(s&&n&&t){console.log("🎯 Auto-loading project location from URL:",s);const c={lat:parseFloat(n),lng:parseFloat(t),address:decodeURIComponent(s)};!isNaN(c.lat)&&!isNaN(c.lng)&&c.lat>=-90&&c.lat<=90&&c.lng>=-180&&c.lng<=180?(y(c),p({title:"Projektstandort geladen",description:`Karte springt automatisch zur Projektadresse: ${c.address}`})):console.error("❌ Invalid coordinates from URL parameters")}},[a,p]);const C=(l,s,n,t)=>{const x=l*Math.PI/180,_=n*Math.PI/180,F=(n-l)*Math.PI/180,q=(t-s)*Math.PI/180,G=Math.sin(F/2)*Math.sin(F/2)+Math.cos(x)*Math.cos(_)*Math.sin(q/2)*Math.sin(q/2);return 6371e3*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))},$=l=>l<1e3?`${l.toFixed(1)}m`:`${(l/1e3).toFixed(2)}km`,A=()=>{S.forEach(l=>{l.setMap(null)}),P([]),k&&(k.setMap(null),N(null)),j(null),console.log("🧹 Measurement cleared")};let R=[],w=!1,z={};try{const l=se({queryKey:["/api/projects"]});R=l.data||[],w=l.isLoading,z=se({queryKey:["/api/config/maps-key"]}).data||{}}catch(l){console.warn("Query context not available:",l)}const U=l=>{console.log("📌 Adding new marker:",l);const s={...l,id:Date.now().toString(),createdAt:new Date().toISOString()};d(n=>{const t=[...n,s];return console.log("🗃️ Updated markers array:",t),t}),p({title:"Marker hinzugefügt",description:`Neuer Marker "${l.title}" wurde erstellt.`})},L=()=>{console.log("🧹 Clearing all markers from map component"),d([]),y(null),window.clearAllMapMarkers&&window.clearAllMapMarkers(),p({title:"Karte bereinigt",description:"Alle Marker und Messungen wurden entfernt."}),console.log("✅ All markers and measurements cleared successfully")},O=()=>{L()},M=()=>{y(null),v&&window.clearSearchMarker&&window.clearSearchMarker(),console.log("🧹 Search location and marker cleared from main component")};return w?e.jsx("div",{className:"h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Lade Kartendaten..."})]})}):e.jsxs("div",{className:"h-screen flex flex-col bg-white",children:[e.jsxs("div",{className:"bg-white border-b shadow-sm px-4 py-3 flex items-center justify-between z-10",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(me,{href:"/",children:e.jsxs(D,{variant:"ghost",size:"sm",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Zurück"]})}),e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Tiefbau Map"})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(he,{value:(g==null?void 0:g.id.toString())||"all",onValueChange:l=>{if(l==="all")m(null),y(null);else{const s=R.find(n=>n.id.toString()===l);if(m(s||null),s!=null&&s.latitude&&(s!=null&&s.longitude)){const n={lat:parseFloat(s.latitude),lng:parseFloat(s.longitude),address:s.name};y(n),p({title:"Projekt ausgewählt",description:`Karte springt zu: ${s.name}`})}}},children:[e.jsx(ge,{className:"w-48",children:e.jsx(fe,{placeholder:"Projekt auswählen"})}),e.jsxs(pe,{children:[e.jsx(ne,{value:"all",children:"Alle Projekte"}),R.map(l=>e.jsx(ne,{value:l.id.toString(),children:l.name},l.id))]})]})})]}),e.jsxs("div",{className:"flex-1 flex",children:[e.jsxs("div",{className:"w-80 bg-white border-r shadow-sm p-4 overflow-y-auto",children:[e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"Baustellenstandort:"}),e.jsx(Z,{placeholder:"Stadt/Gemeinde",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"Baustellenstraße:"}),e.jsx(Z,{placeholder:"Straße und Hausnummer",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsx(V,{className:"text-sm font-medium text-gray-700",children:"Baustellenpostleitzahl:"}),e.jsx(Z,{placeholder:"PLZ",className:"mt-1"})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"font-medium text-gray-900 mb-2",children:"Adresssuche"}),e.jsx(Ie,{onLocationSelect:l=>{console.log("📍 Address selected from component:",l),y(l)},placeholder:"Vollständige Adresse mit Hausnummer (z.B. Hauptstraße 5, München)"}),i&&e.jsxs(D,{size:"sm",variant:"outline",onClick:M,className:"w-full mt-2",children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Suchmarker löschen"]})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Werkzeuge"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs(D,{variant:h==="marker"?"default":"outline",onClick:()=>{const l=h==="marker"?"":"marker";console.log("🔘 Button clicked! Setting drawing mode to:",l),b(l)},className:"w-full justify-start",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),h==="marker"?"✅ Marker-Modus aktiv":"Marker setzen"]}),e.jsxs(D,{variant:E?"default":"outline",onClick:()=>{I(!E),E&&A(),console.log("📏 Measurement mode:",!E)},className:"w-full justify-start",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),E?"✅ Messung aktiv":"Distanz messen"]}),e.jsxs(D,{variant:h==="area"?"default":"outline",onClick:()=>b(h==="area"?"":"area"),className:"w-full justify-start",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Fläche messen"]})]}),E&&e.jsxs("div",{className:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md",children:[e.jsx("p",{className:"text-xs text-blue-700 mb-2",children:e.jsx("strong",{children:"📏 Messmodus aktiv"})}),e.jsx("p",{className:"text-xs text-blue-600",children:"Klicken Sie auf die Karte, um 2 Punkte zu setzen."}),S.length>0&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Punkt ",S.length,"/2 gesetzt"]}),o&&e.jsxs("div",{className:"mt-2 p-2 bg-white border border-blue-300 rounded",children:[e.jsxs("p",{className:"text-sm font-medium text-blue-900",children:["Distanz: ",e.jsx("strong",{children:$(o)})]}),e.jsx("p",{className:"text-xs text-blue-600",children:"Luftlinie"})]})]}),(S.length>0||o)&&e.jsxs(D,{variant:"outline",onClick:A,size:"sm",className:"w-full justify-start text-red-600 hover:text-red-700 mt-2",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Messung löschen"]})]}),i&&e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"🎯 Suchposition"}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-3",children:[e.jsx("p",{className:"text-sm text-blue-700",children:i.address}),e.jsxs("small",{className:"text-blue-600",children:["📍 ",i.lat.toFixed(6),", ",i.lng.toFixed(6)]})]}),r.length>0&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-md p-3",children:[e.jsx("h4",{className:"font-medium text-red-800 mb-2",children:"📍 Entfernung zu Markern"}),r.map(l=>{const s=C(i.lat,i.lng,l.lat,l.lng);return{marker:l,distance:s}}).sort((l,s)=>l.distance-s.distance).slice(0,3).map(({marker:l,distance:s},n)=>e.jsxs("div",{className:"flex justify-between items-center text-sm mb-1",children:[e.jsx("span",{className:"text-red-700 truncate",children:l.title}),e.jsx("span",{className:"text-red-600 font-medium ml-2",children:$(s)})]},l.id))]})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center",children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Professionelle Geoportale"]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs(D,{variant:"outline",onClick:()=>window.open("https://geoportal.bayern.de/denkmalatlas/","_blank"),className:"w-full justify-start bg-white hover:bg-blue-50",children:[e.jsx(B,{className:"h-4 w-4 mr-2 text-blue-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-medium",children:"Denkmalatlas Bayern"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Archäologische Fundstellen"})]})]}),e.jsxs(D,{variant:"outline",onClick:()=>window.open("https://atlas.bayern.de/","_blank"),className:"w-full justify-start bg-white hover:bg-blue-50",children:[e.jsx(B,{className:"h-4 w-4 mr-2 text-green-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-medium",children:"BayernAtlas"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Topografische Karten"})]})]}),e.jsxs(D,{variant:"outline",onClick:()=>window.open("https://geoportal.bgr.de/mapapps/resources/apps/geoportal/index.html?lang=de","_blank"),className:"w-full justify-start bg-white hover:bg-blue-50",children:[e.jsx(B,{className:"h-4 w-4 mr-2 text-orange-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-medium",children:"BGR Geoportal"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Geologische Daten"})]})]}),e.jsxs(D,{variant:"outline",onClick:()=>window.open("https://www.lfu.bayern.de/boden/index.htm","_blank"),className:"w-full justify-start bg-white hover:bg-blue-50",children:[e.jsx(B,{className:"h-4 w-4 mr-2 text-purple-600"}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-medium",children:"LfU Bodeninformationen"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Spezielle Bodendaten"})]})]})]}),e.jsx("div",{className:"mt-3 p-2 bg-white/60 border border-blue-300 rounded-md",children:e.jsxs("p",{className:"text-xs text-blue-700",children:[e.jsx("strong",{children:"💡 Hinweis:"})," Alle Geoportale öffnen in neuen Tabs für parallele Recherche"]})})]})]}),h&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md",children:e.jsxs("p",{className:"text-sm font-medium text-blue-800",children:[h==="marker"&&"📍 Klicken Sie auf die Karte, um einen Marker zu setzen",h==="line"&&"📏 Klicken Sie auf die Karte, um eine Distanz zu messen",h==="area"&&"📐 Klicken Sie auf die Karte, um eine Fläche zu messen"]})}),e.jsxs("div",{className:"p-2 bg-gray-50 border rounded-md mb-4",children:[e.jsxs("p",{className:"text-xs text-gray-600",children:["Projekte: ",R.length," | Marker: ",r.length]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Modus: ",h||"Kein Modus"," | Mit Koordinaten: ",R.filter(l=>l.latitude&&l.longitude).length]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs(D,{size:"sm",variant:"outline",onClick:O,className:"w-full",children:[e.jsx(le,{className:"h-4 w-4 mr-1"}),"Alle Marker löschen"]})})]}),e.jsx("div",{className:"flex-1 relative",children:z&&z.apiKey?e.jsx(X.Wrapper,{apiKey:z.apiKey,libraries:["drawing","geometry"],render:l=>l===X.Status.LOADING?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Lade Google Maps..."})]})}):l===X.Status.FAILURE?e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-red-50",children:e.jsx("p",{className:"text-red-500",children:"Fehler beim Laden der Karte"})}):e.jsx(Ce,{projects:R,selectedProject:g,onProjectSelect:m,markers:r,onMarkerAdd:U,onMarkersCleared:L,searchLocation:i,drawingMode:h,onDrawingModeChange:b,onMapReady:u})}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:e.jsx("p",{className:"text-gray-500",children:"Google Maps API-Schlüssel wird geladen..."})})})]})]})}export{Oe as default};
